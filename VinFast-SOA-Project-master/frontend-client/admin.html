<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard Qu·∫£n L√Ω ƒê∆°n H√†ng (L2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .chart-container { position: relative; height: 350px; max-height: 400px; width: 100%; padding: 10px; }
        .status { display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.85em; }
        .Paid { background-color: #d1fae5; color: #065f46; } 
        .Scheduled { background-color: #dbeafe; color: #1e40af; } 
        .Pending { background-color: #fff3cd; color: #856404; }
        .Confirmed { background-color: #e0e7ff; color: #4338ca; }
        
        /* Chatbox Style */
        .chat-fixed { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 450px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 1000; overflow: hidden; }
        .chat-header { background: #1464F4; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f8fafc; border-bottom: 1px solid #eee; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 13px; max-width: 85%; line-height: 1.4; position: relative; }
        .msg-admin { align-self: flex-end; background: #1464F4; color: white; border-bottom-right-radius: 2px; }
        .msg-customer { align-self: flex-start; background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 2px; }
        .msg-system { align-self: center; background: #fef3c7; color: #92400e; border-radius: 6px; font-style: italic; font-size: 11px; text-align: center; max-width: 95%; }
        .msg-time { font-size: 10px; opacity: 0.7; margin-bottom: 2px; display: block; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto py-10 px-4">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">VinFast Admin - ƒêi·ªÅu ph·ªëi ƒê∆°n h√†ng</h1>
            <div id="auth-group"></div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            <div id="revenue-card" class="card p-6 flex flex-col justify-center items-center">
                <div class="text-lg font-semibold text-gray-500">Doanh thu ƒê·∫∑t c·ªçc (Paid)</div>
                <div id="total-revenue" class="text-4xl font-extrabold text-blue-600 mt-2">0 VND</div>
            </div>
            
            <div class="card p-6 lg:col-span-1">
                <h3 class="text-xl font-semibold mb-3 text-center">Tr·∫°ng th√°i ƒê∆°n h√†ng</h3>
                <div class="chart-container">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>
            
            <div class="card p-6 lg:col-span-1">
                <h3 class="text-xl font-semibold mb-3 text-center">T·ªìn kho H·ªá th·ªëng</h3>
                <div class="chart-container">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Qu·∫£n l√Ω ƒê·∫∑t c·ªçc & L·ªãch h·∫πn</h3>
                <button onclick="loadDashboard()" class="text-blue-600 text-sm hover:underline">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kh√°ch H√†ng</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">S·∫£n Ph·∫©m</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">S·ªë Ti·ªÅn</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-6 py-4 text-center">ƒêang k·∫øt n·ªëi API Gateway...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[999] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl w-[450px] shadow-2xl">
            <h3 class="text-xl font-bold text-blue-700 mb-4">üìÖ Thi·∫øt l·∫≠p L·ªãch h·∫πn</h3>
            <hr class="mb-4">
            <input type="hidden" id="currentOrderId">
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">üìç Ch·ªçn Showroom:</label>
                <select id="showroomAddress" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="VinFast Smart City, H√† N·ªôi">VinFast Smart City, H√† N·ªôi</option>
                    <option value="VinFast Th·∫£o ƒêi·ªÅn, TP.HCM">VinFast Th·∫£o ƒêi·ªÅn, TP.HCM</option>
                    <option value="VinFast Ng√¥ Quy·ªÅn, ƒê√† N·∫µng">VinFast Ng√¥ Quy·ªÅn, ƒê√† N·∫µng</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">‚è∞ Th·ªùi gian h·∫πn:</label>
                <input type="datetime-local" id="appointmentTime" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="submitSchedule()" class="flex-1 bg-blue-600 text-white py-2 rounded-md font-bold hover:bg-blue-700">G·ª≠i Th√¥ng B√°o</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="chatWrapper" class="chat-fixed">
        <div class="chat-header">
            <span class="font-bold flex items-center gap-2">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                Chat: <span id="chatWithUser">Kh√°ch h√†ng</span>
            </span>
            <button onclick="closeChat()" class="text-white text-xl hover:text-gray-200">&times;</button>
        </div>
        <input type="hidden" id="currentChatOrderId">
        <div id="chatMessages" class="chat-messages"></div>
        <div class="p-3 border-t flex gap-2 bg-white">
            <input type="text" id="chatInput" onkeypress="if(event.key==='Enter') sendChatMessage()" class="flex-1 border rounded-md p-2 text-sm focus:outline-none focus:border-blue-500" placeholder="Nh·∫≠p n·ªôi dung...">
            <button onclick="sendChatMessage()" class="bg-blue-600 text-white px-4 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">G·ª≠i</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // 1. KH·ªûI T·∫†O DASHBOARD & L·∫ÆNG NGHE SOCKET
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof updateHeaderUI === 'function') updateHeaderUI();
            if (typeof loadDashboard === 'function') loadDashboard();

            if (socket) {
                socket.on('receive_message', (msg) => {
                    const activeOrderId = document.getElementById('currentChatOrderId').value;
                    if (activeOrderId == msg.order_id) {
                        appendMessageToUI(msg);
                    }
                });
            }
        });

        // 2. M·ªû CHAT & T·∫¢I L·ªäCH S·ª¨ (Kh·∫Øc ph·ª•c l·ªói m·∫•t tin nh·∫Øn)
        async function openChat(orderId, customerName) {
            const chatWrapper = document.getElementById('chatWrapper');
            const chatMessages = document.getElementById('chatMessages');
            const chatWithUser = document.getElementById('chatWithUser');
            
            chatWrapper.style.display = 'flex';
            chatWithUser.textContent = customerName;
            document.getElementById('currentChatOrderId').value = orderId;
            chatMessages.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">ƒêang t·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán...</p>';

            socket.emit('join', { order_id: parseInt(orderId) });

            try {
                // G·ªçi qua Gateway c·ªïng 8000
                const response = await fetch(`${BASE_GATEWAY_URL}/chat/api/v1/chat/${orderId}`, {
                    headers: getAuthHeader()
                });
                if (response.ok) {
                    const history = await response.json();
                    chatMessages.innerHTML = ''; 
                    history.forEach(msg => appendMessageToUI(msg));
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                chatMessages.innerHTML = '<p class="text-center text-red-500 text-xs">L·ªói: Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }

        // 3. G·ª¨I TIN NH·∫ÆN T·ª™ ADMIN
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const orderId = document.getElementById('currentChatOrderId').value;
            const content = input.value.trim();

            if (!content || !orderId) return;

            const msgData = {
                order_id: parseInt(orderId),
                role: 'admin',
                name: 'Qu·∫£n tr·ªã vi√™n',
                content: content
            };

            // Hi·ªÉn th·ªã ngay l√™n UI (Optimistic UI) ƒë·ªÉ m∆∞·ª£t m√† h∆°n
            appendMessageToUI({
                ...msgData,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });

            socket.emit('send_message', msgData);
            input.value = '';
        }

        // 4. HI·ªÇN TH·ªä TIN NH·∫ÆN L√äN UI
        function appendMessageToUI(msg) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            
            let typeClass = 'msg-customer';
            if (msg.role === 'admin') typeClass = 'msg-admin';
            if (msg.role === 'system') typeClass = 'msg-system';
            
            msgDiv.className = `msg ${typeClass}`;
            
            if (msg.role !== 'system') {
                msgDiv.innerHTML = `
                    <span class="msg-time">${msg.name} ‚Ä¢ ${msg.time || ''}</span>
                    <div>${msg.content}</div>
                `;
            } else {
                msgDiv.innerHTML = `<div>${msg.content}</div>`;
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 5. X√ÅC NH·∫¨N L·ªäCH H·∫∏N (G·ª≠i th√¥ng b√°o h·ªá th·ªëng t·ª± ƒë·ªông)
        async function submitSchedule() {
            const orderId = document.getElementById('currentOrderId').value;
            const address = document.getElementById('showroomAddress').value;
            const time = document.getElementById('appointmentTime').value;

            if (!time) return alert("Vui l√≤ng ch·ªçn th·ªùi gian h·∫πn!");

            try {
                // B∆∞·ªõc 1: G·ªçi Order Service qua Gateway
                const response = await fetch(`${BASE_GATEWAY_URL}/orders/api/v1/orders/${orderId}/confirm`, {
                    method: 'PUT',
                    headers: getAuthHeader()
                });

                if (response.ok) {
                    // B∆∞·ªõc 2: G·ª≠i th√¥ng b√°o h·ªá th·ªëng v√†o Chat
                    const appointmentLabel = new Date(time).toLocaleString('vi-VN');
                    await fetch(`${BASE_GATEWAY_URL}/chat/api/v1/chat/system_notify`, {
                        method: 'POST',
                        headers: getAuthHeader(),
                        body: JSON.stringify({
                            order_id: parseInt(orderId),
                            content: `üìÖ TH√îNG B√ÅO: ƒê√£ x√°c nh·∫≠n l·ªãch h·∫πn t·∫°i ${address} v√†o l√∫c ${appointmentLabel}.`
                        })
                    });

                    alert("X√°c nh·∫≠n l·ªãch h·∫πn th√†nh c√¥ng!");
                    closeModal();
                    loadDashboard(); 
                } else {
                    alert("L·ªói khi x√°c nh·∫≠n l·ªãch h·∫πn.");
                }
            } catch (error) {
                console.error("Schedule error:", error);
                alert("L·ªói k·∫øt n·ªëi m√°y ch·ªß.");
            }
        }

        function closeChat() {
            document.getElementById('chatWrapper').style.display = 'none';
            document.getElementById('currentChatOrderId').value = '';
        }

        function closeModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
        }
    </script>
</body>
</html>